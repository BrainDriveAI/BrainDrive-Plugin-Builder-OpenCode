---
description: Run compatibility mapping - Phase 2 truth gathering
allowed-tools: Read, Glob, Grep, Bash
---

You are the BrainDrive Plugin Builder running Phase 2: Compatibility Mapping.

## Prerequisites

### Load Context File (CRITICAL - RUN FIRST)

```bash
# Check if context file exists
if [ ! -f .plugin-builder-context.json ]; then
  echo "❌ ERROR: Plugin builder context not found."
  echo ""
  echo "This usually means you haven't started a plugin build session yet."
  echo ""
  echo "Please run: /start"
  echo ""
  echo "If you were in the middle of a build, the context file may have been"
  echo "accidentally deleted. You'll need to restart from /start."
  exit 1
fi

# Load and display context
cat .plugin-builder-context.json | jq .
```

### Validate Phase

```bash
# Check current phase
CURRENT_PHASE=$(jq -r '.phase' .plugin-builder-context.json)

if [ "$CURRENT_PHASE" != "start" ]; then
  echo "⚠️  WARNING: Expected phase 'start' but found '$CURRENT_PHASE'"
  echo "This command should run after /start. Continue anyway? (yes/no)"
  # Wait for user confirmation
fi
```

The user must have completed Phase 1 (interview) first. The context file should exist with phase="start".

## PHASE 2: Compatibility Mapping

Your goal is to determine the exact plugin format BrainDrive expects.

### Step A: Detect Operating Mode

**IMPORTANT:** Search ONLY in the current project root. Do NOT search outside.

```bash
# Search ONLY in current directory
find . -maxdepth 4 -name "BrainDrive" -type d 2>/dev/null | head -1
find . -maxdepth 5 -name "PluginTemplate" -type d 2>/dev/null | head -1
```

Based on findings:
- **If PluginTemplate found in ./BrainDrive/backend/plugins/shared/PluginTemplate:** Announce "Mode A: Repo-aware mode activated"
- **If not found:** Announce "Mode B: Standalone mode - using bundled Reference Pack at ./.opencode/reference-pack/PluginTemplate-REAL/"

### Step B: Gather Plugin Structure Requirements

**For Mode A (Repo-aware):**
1. Read the actual PluginTemplate structure from `./BrainDrive/backend/plugins/shared/PluginTemplate/v1.0.0/`
2. Examine:
   - `package.json` for manifest fields
   - `lifecycle_manager.py` for plugin_data and module_data structure
   - `webpack.config.js` for Module Federation config
   - `src/` folder structure
   - `tsconfig.json` for TypeScript config

**For Mode B (Standalone):**
Use the bundled Reference Pack at `./.opencode/reference-pack/PluginTemplate-REAL/`

### ACTUAL BrainDrive Plugin Structure:

```
plugin-name/
├── package.json                 # NPM manifest
├── lifecycle_manager.py         # Backend lifecycle hooks (REQUIRED)
├── webpack.config.js            # Module Federation build config
├── tsconfig.json                # TypeScript config
├── src/                         # Source files (NOT frontend/src/)
│   ├── index.tsx                # Entry point
│   ├── PluginTemplate.tsx       # Main component
│   ├── PluginTemplate.css       # Styles
│   ├── types.ts                 # TypeScript interfaces
│   ├── utils.ts                 # Utility functions
│   ├── components/              # Reusable components
│   │   ├── ErrorBoundary.tsx
│   │   ├── ErrorDisplay.tsx
│   │   ├── LoadingSpinner.tsx
│   │   └── SettingsExample.tsx
│   ├── services/                # Service layer
│   │   └── PluginService.ts
│   └── utils/
│       └── errorHandling.ts
├── public/                      # Static assets
│   └── icon.png
├── dist/                        # Build output (generated by webpack)
│   └── remoteEntry.js           # Module Federation entry
├── references/                  # Documentation (optional)
├── DEVELOPER_GUIDE.md          # Setup guide (optional)
└── README.md                    # Plugin docs (optional)
```

### Step C: Output Compatibility Map

Create and display a Compatibility Map:

```
=== COMPATIBILITY MAP ===

Operating Mode: [A/B]
Source: [Path to template]

Required Folder Structure:
- /package.json                  # NPM manifest
- /lifecycle_manager.py          # Python lifecycle manager (REQUIRED)
- /webpack.config.js             # Webpack + Module Federation config
- /tsconfig.json                 # TypeScript config
- /src/                          # Source files (NOT frontend/src/)
  ├── index.tsx                  # Entry point
  ├── PluginTemplate.tsx         # Main component (rename to your plugin)
  ├── PluginTemplate.css
  ├── types.ts
  ├── components/
  ├── services/
  └── utils/
- /public/                       # Static assets
  └── icon.png
- /dist/                         # Build output (generated)
  └── remoteEntry.js

Required Manifest Fields (package.json):
- name (kebab-case, e.g., "task-manager")
- version (semver, e.g., "1.0.0")
- description
- main: "dist/remoteEntry.js"
- scripts: { "build": "webpack --mode production" }

Lifecycle Manager (lifecycle_manager.py):
- Class: YourPluginLifecycleManager(BaseLifecycleManager)
- plugin_data dictionary with:
  - name, description, version, type, icon, category
  - plugin_slug (PascalCase, e.g., "TaskManager")
  - scope (PascalCase, must match webpack)
  - bundle_location: "dist/remoteEntry.js"
- module_data list with module definitions
- Methods: get_plugin_metadata(), get_module_metadata()
- Methods: _perform_user_installation(), _perform_user_uninstallation()

Webpack Config (webpack.config.js):
- Module Federation Plugin
- name: PascalCase (must match lifecycle_manager scope)
- filename: "remoteEntry.js"
- exposes: { "./index": "./src/index" }
- shared: { react: singleton, react-dom: singleton }

Build Output:
- Builds to dist/remoteEntry.js
- Module Federation remote format
- Exposes component via window[scope]

Available BrainDrive Services (inject via props):
- api: HTTP client for BrainDrive backend
- theme: Current theme (dark/light) and colors
- settings: Plugin settings storage
- event: Pub/sub messaging
- pageContext: Current page info

"Must Match Exactly" Constraints:
- package.json name (kebab-case) ↔ folder name
- lifecycle_manager.py scope (PascalCase) ↔ webpack name
- lifecycle_manager.py bundle_location ↔ webpack output
- All versions must match across files
```

## Update Context File

After completing compatibility mapping, update the context file:

```bash
# Update phase to 'map'
jq '.phase = "map" | .last_updated_at = (now | todate)' .plugin-builder-context.json > .plugin-builder-context.tmp
mv .plugin-builder-context.tmp .plugin-builder-context.json

echo "✅ Context updated: phase = map"
```

Tell the user: "Phase 2 complete! Run `/plan` to continue to Phase 3 (File-by-file Plan)."
